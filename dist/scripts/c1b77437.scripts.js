"use strict";angular.module("mctApp",["ngRoute","ngSanitize","ngResource"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/posts",{templateUrl:"views/posts/index.html",controller:"PostsCtrl"}).when("/posts/new",{templateUrl:"views/posts/new.html",controller:"NewPostCtrl"}).when("/posts/:name",{templateUrl:"views/posts/show.html",controller:"ShowPostCtrl"}).when("/posts/:name/edit",{templateUrl:"views/posts/edit.html",controller:"EditPostCtrl"}).when("/molecules",{templateUrl:"views/molecules/index.html",controller:"MoleculesCtrl"}).when("/molecules/new",{templateUrl:"views/molecules/sketcher.html",controller:"MoleculeSketcherCtrl"}).when("/molecules/:name",{templateUrl:"views/molecules/show.html",controller:"ShowMoleculeCtrl"}).when("/molecules/:name/edit",{templateUrl:"views/molecules/sketcher.html",controller:"MoleculeSketcherCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("mctApp").controller("MainCtrl",["$scope","$location",function(a,b){a.$location=b,a.$watch("$location.path()",function(b){a.activeNavId=b||"/"}),a.getClass=function(b){return a.activeNavId?a.activeNavId.substring(0,b.length)===b?"active":"":void 0}}]),angular.module("mctApp").controller("AppCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("mctApp").factory("Post",["$resource",function(a){return a("posts/:name",{name:"@urlString"},{})}]),angular.module("mctApp").factory("Tag",["$resource",function(a){return a("tags/:name",{name:"@urlString"},{})}]),angular.module("mctApp").filter("tagFilter",function(){return function(a,b){function c(a){return function(b){a.push(b.name)}}if(b.length<1)return a;if(a.$resolved){var d=[];console.log(a.length);for(var e=0;e<b.length;e++)for(var f=b[e],g=0;g<a.length;g++){var h=a[g],i=[],j=c(i);h.tags.map(j),i.indexOf(f)>=0&&d.push(h)}return d}}}),angular.module("mctApp").controller("PostsCtrl",["$scope","$filter","Post","Tag",function(a,b,c,d){a.query="",a.selectedTags=[],a.demoPosts=[{title:"First Post",content:"Foo!",tags:["JS","Linux"]},{title:"Second Post",content:"Foo!",tags:["Python","Linux"]},{title:"Third Post",content:"Foo!",tags:["JS","Ubuntu"]}],a.posts=c.query(),a.tags=d.query(),a.getPosts=function(){return b("tagFilter")(a.posts,a.selectedTags)};var e=new Showdown.converter;a.getTagClass=function(b){var c=a.selectedTags.indexOf(b)>=0?"active":"";return c},a.toggleTag=function(b){var c=a.selectedTags.indexOf(b);c>=0?a.selectedTags.splice(c,1):a.selectedTags.push(b),console.log(a.selectedTags)},a.parseContent=function(a){return e.makeHtml(a)}}]),angular.module("mctApp").controller("NewPostCtrl",["$scope","$location","Post",function(a,b,c){a.post={title:"",tags:null,content:""},a.preview="";var d=new Showdown.converter;a.$watch("post.content",function(){a.post.content&&(a.preview=d.makeHtml(a.post.content))}),a.parseContent=function(b){b&&(a.preview=d.makeHtml(b))},a.savePost=function(){var d=new c(a.post);d.$save(),b.path("/posts")}}]),angular.module("mctApp").controller("EditPostCtrl",["$scope","$location","$routeParams","Post",function(a,b,c,d){a.post=d.get({name:c.name});var e=new Showdown.converter;a.$watch("post.content",function(){a.post.content&&(a.preview=e.makeHtml(a.post.content))}),a.savePost=function(){a.post.$save(),b.path("/posts")}}]),angular.module("mctApp").controller("ShowPostCtrl",["$scope","$location","$routeParams","Post",function(a,b,c,d){a.post=d.get({name:c.name});var e=new Showdown.converter;a.$watch("post.content",function(){a.post.content&&(a.content=e.makeHtml(a.post.content))}),a.editPost=function(){b.path("/posts/"+a.post.urlString+"/edit")},a.deletePost=function(){a.post.$delete(),b.path("/posts")}}]),angular.module("mctApp").factory("Molecule",["Atom","Bond",function(a,b){var c;return c=function(a,b,c){this.name=a,this.molFile=b,this.ctx=c,this.atoms=[],this.bonds=[],this.selection=[],this.selectedAtom=null,this.selectedBond=null,this.dirty=!1},c.prototype.clearSelection=function(){for(var a=0;a<this.selection.length;a++){var b=this.selection[a];b.deselect()}this.selection.splice(0,this.selection.length)},c.prototype.changeSelection=function(a){this.clearSelection();for(var b=0;b<a.length;b++){var c=a[b];c.select(),this.selection.push(c)}},c.prototype.draw=function(){if(this.ctx){var a=this;this.ctx.clearRect(0,0,500,500),this.bonds.map(function(b){b.draw(a.ctx)}),this.atoms.map(function(b){b.draw(a.ctx)})}},c.prototype.findNearestObject=function(a,b,c){var d,e=this.findNearestAtom(a,b,c),f=this.findNearestBond(a,b,c);return d=e.distance<1.5*f.distance?{obj:e.atom,score:e.distance}:{obj:f.bond,score:f.distance}},c.prototype.findNearestAtom=function(a,b,c){for(var d,e=999,f=this.atoms.length,g=0;f>g;g++){var h=this.atoms[g],i=h.distanceFrom(a,b,c);e>i&&(e=i,d=h)}return{atom:d,distance:e}},c.prototype.findNearestBond=function(a,b,c){for(var d,e=999,f=this.bonds.length,g=0;f>g;g++){var h=this.bonds[g],i=h.distanceFrom(a,b,c);e>i&&(e=i,d=h)}return{bond:d,distance:e}},c.prototype.getBoundingBox=function(){var a=this.atoms.map(function(a){return{x:a.x,y:a.y,z:a.z,index:a.index}});a.sort(function(a,b){return a.x-b.x}),this.minX=a[0].x,this.maxX=a[a.length-1].x,a.sort(function(a,b){return a.y-b.y}),this.minY=a[0].y,this.maxY=a[a.length-1].y,a.sort(function(a,b){return a.z-b.z}),this.minZ=a[0].z,this.maxZ=a[a.length-1].z,this.width=this.maxX-this.minX,this.height=this.maxY-this.minY,this.depth=this.maxZ-this.minZ,this.depth=1/0===this.depth?1:this.depth,console.log(this.width),console.log(this.height),console.log(this.depth)},c.prototype.normalize=function(){for(var a=0;a<this.atoms.length;a++){var b=this.atoms[a];b.x=b.x-(this.minX+this.width)/2,b.x=b.x/(1*this.width/2),b.x=b.x.toFixed(3),b.y=b.y-(this.minY+this.height)/2,b.y=b.y/(1*this.height/2),b.y=b.y.toFixed(3),b.z=b.z-(this.minZ+this.depth)/2,b.z=b.z/(1*this.depth/2),b.z=b.z?b.z:1,b.z=b.z.toFixed(3),b.z=1}console.log(this.atoms)},c.prototype.satisfy=function(a){var b;for(b=0;b<this.bonds.length;b++){var c=this.bonds[b];c.satisfy(a)}},c.prototype.addAtom=function(b,c,d,e){var f=new a(b,c,d,e,this);return this.draw(),this.dirty=!0,f},c.prototype.addBond=function(a,c,d){var e=new b(a,c,d,this);return this.draw(),e},c.prototype.generateMolFile=function(){var a=this.atoms.length,b=this.bonds.length,c=[];c.push(a+" "+b);for(var d=0;a>d;d++){var e=this.atoms[d];c.push([e.element,e.x,e.y,e.z].join(" "))}for(var f=0;b>f;f++){var g=this.bonds[f];c.push([g.startAtom.index,g.endAtom.index,g.order].join(" "))}var h=c.join("\n");return this.molFile=h,h},c.prototype.parseMolFile=function(){console.log(this.molFile);var c,d,e,f=this.molFile.split("\n"),g=f[0].split(" "),h=parseInt(g[0],10),i=parseInt(g[1],10);for(e=0;h>e;e++){c=f[e+1],d=c.split(" ");var j=d[0],k=parseFloat(d[1]),l=parseFloat(d[2]),m=parseFloat(d[3]);new a(j,k,l,m,this)}for(e=0;i>e;e++){c=f[e+h+1],d=c.split(" ");var n=parseInt(d[0],10),o=this.atoms[n],p=parseInt(d[1],10),q=this.atoms[p],r=parseInt(d[2],10);new b(o,q,r,this)}},c}]),angular.module("mctApp").factory("Atom",function(){var a;return a=function(a,b,c,d,e){this.element=a,this.x=b,this.y=c,this.z=d,this.molecule=e,this.molecule.atoms.push(this),this.index=this.molecule.atoms.indexOf(this),this.bonds=[],this.atoms=[]},a.prototype.select=function(){this.molecule.selectedAtom&&this.molecule.selectedAtom.deselect(),this.molecule.selectedAtom=this},a.prototype.deselect=function(){this.molecule.selectedAtom=!1},a.prototype.distanceFrom=function(a,b,c){var d=this.x-a,e=this.y-b,f=this.z-c,g=Math.sqrt(d*d+e*e+f*f);return g},a.prototype.change=function(){},a.prototype.draw=function(a){a.fillStyle="white",a.fillRect(this.x-5,this.y-5,15,12),a.fill(),a.beginPath(),a.fillStyle=this.molecule.selectedAtom===this?"red":"black",a.fillText(this.element,this.x-2,this.y+5),a.closePath(),a.fill()},a.prototype.bondTo=function(a){var b=this.molecule.addBond(this,a,1);return b},a.prototype.shift=function(a,b,c){this.x=this.x+a,this.y=this.y+b,this.z=this.z+c},a}),angular.module("mctApp").factory("Bond",function(){var a;return a=function(a,b,c,d){this.startAtom=a,this.startAtom.bonds.push(this),this.endAtom=b,this.endAtom.bonds.push(this),this.order=c,this.restLength=50,this.molecule=d,this.molecule.bonds.push(this),this.index=this.molecule.bonds.indexOf(this)},a.prototype.change=function(){this.order=this.order++%3+1,console.log(this.order)},a.prototype.distanceFrom=function(a,b,c){var d=(this.startAtom.x-this.endAtom.x)/2+this.endAtom.x,e=(this.startAtom.y-this.endAtom.y)/2+this.endAtom.y,f=(this.startAtom.z-this.endAtom.z)/2+this.endAtom.z,g=d-a,h=e-b,i=f-c,j=Math.sqrt(g*g+h*h+i*i);return j},a.prototype.draw=function(a){a.beginPath(),a.strokeStyle=this.molecule.selectedBond===this?"red":"black";for(var b=1;b<=this.order;b++)a.moveTo(this.startAtom.x+(2*b-1),this.startAtom.y+2*b-1),a.lineTo(this.endAtom.x+2*b-1,this.endAtom.y+2*b-1);a.stroke()},a.prototype.select=function(){this.molecule.selectedBond&&this.molecule.selectedBond.deselect(),this.molecule.selectedBond=this},a.prototype.deselect=function(){this.molecule.selectedBond=!1},a.prototype.shift=function(){},a.prototype.satisfy=function(a){console.log(a)},a}),angular.module("mctApp").factory("MoleculeStore",["$resource",function(a){return a("molecules/:name",{name:"@urlString"})}]),angular.module("mctApp").controller("NewMoleculeCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("mctApp").controller("MoleculesCtrl",["$scope","MoleculeStore",function(a,b){a.molecules=b.query()}]),angular.module("mctApp").controller("ShowMoleculeCtrl",["$scope","$routeParams","Molecule","MoleculeStore",function(a,b,c,d){a.moleculeName=b.name,b.name?a.moleculeStore=d.get({name:b.name},function(b){a.molecule=new c(b.name,b.molFile,a.ctx),a.name=a.molecule.name,a.molecule.parseMolFile(),a.molecule.draw()}):a.molecule=new c(!1,!1,a.ctx)}]),angular.module("mctApp").controller("EditMoleculeCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("mctApp").controller("MoleculeSketcherCtrl",["$scope","$filter","$location","$routeParams","Molecule","MoleculeStore",function(a,b,c,d,e,f){a.canvas=document.getElementById("chem-sketcher"),a.div=angular.element(document.getElementById("chem-sketcher")),a.ctx=a.canvas.getContext("2d"),d.name?a.moleculeStore=f.get({name:d.name},function(b){a.molecule=new e(b.name,b.molFile,a.ctx),a.name=a.molecule.name,a.molecule.parseMolFile(),a.molecule.draw()}):a.molecule=new e(!1,!1,a.ctx),a.dragging=!1,a.atomTool="C",a.bondTool="1",a.mouseTool=!1,a.mouseTools=["select","group","delete"],a.bondTypes=["1","2","3","d","s"],a.atoms=["C","H","N","O","P","S","B","Si","F","Cl","Br","I"],a.atomGroups=b("groupBy")(a.atoms,6),a.handleMouseDown=function(b){var c=b.offsetX,d=b.offsetY,e=a.molecule;if(a.mouseTool&&"select"===a.mouseTool){var f=e.findNearestObject(c,d,0);e.changeSelection([f.obj]),a.dragging=!0,a.dragStart={x:c,y:d},e.draw()}},a.handleMouseMove=function(b){var c=b.offsetX,d=b.offsetY,e=a.molecule;if(a.dragging){var f=c-a.dragStart.x,g=d-a.dragStart.y;e.selection.map(function(b){b.shift(f,g,0),a.dragStart.x=c,a.dragStart.y=d}),e.draw()}},a.handleMouseUp=function(b){var c=b.offsetX,d=b.offsetY,e=a.molecule;a.dragging&&(a.dragging=!1);var f=e.findNearestObject(c,d,0);if(a.mouseTool)a.molecule.selection.indexOf(f.obj)>=0&&f.obj.change(),e.changeSelection([f.obj]);else if(a.atomTool&&a.bondTool){var g;g=f.score<15?f.obj:e.addAtom(a.atomTool,c,d,0),e.selectedAtom&&e.selectedAtom.distanceFrom(c,d,0)<75&&e.selectedAtom.bondTo(g),e.changeSelection([g])}e.draw()},a.div.on("mousedown",a.handleMouseDown),a.div.on("mousemove",a.handleMouseMove),a.div.on("mouseup",a.handleMouseUp),a.satisfy=function(){a.molecule.satisfy(.1)},a.changeAtomTool=function(b){a.atomTool=b,a.bondTool=a.bondTool?a.bondTool:"1",a.mouseTool=!1},a.getAtomToolClass=function(b){var c=a.atomTool===b?"active":"";return c},a.changeMouseTool=function(b){a.mouseTool=b,a.atomTool=!1,a.bondTool=!1},a.getMouseToolClass=function(b){var c=a.mouseTool===b?"active":"";return c},a.changeBondTool=function(b){a.bondTool=b,a.mouseTool=!1,a.atomTool=a.atomTool?a.atomTool:"C"},a.getBondToolClass=function(b){var c=a.bondTool===b?"active":"";return c},a.generateMolFile=function(){var b=a.molecule.generateMolFile();console.log(b)},a.saveMolecule=function(){var b=a.molecule.generateMolFile();if(a.moleculeStore)a.moleculeStore.molFile=b,a.moleculeStore.$save();else{var d=new f({name:a.name,molFile:b});d.$save()}c.path("/chemistry/molecules")}}]),angular.module("mctApp").filter("groupBy",function(){return function(a,b){for(var c,d=[],e=0;e<a.length;e++)e%b===0&&(c=[],d.push(c)),c.push(a[e]);return d}});